<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <meta property="og:title" content="Açaí Ellegance | Pedido Premium" />
  <meta property="og:description" content="Sabor inigualável. Peça agora." />
  <meta property="og:image" content="logoacai.jpeg" />

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="logoacai.jpeg" />

  <title>Açaí Ellegance</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
            display: ['"Outfit"', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f5f3ff',
              100: '#ede9fe',
              500: '#8b5cf6',
              600: '#7c3aed',
              900: '#4c1d95',
            },
            whatsapp: {
              500: '#25D366',
              600: '#128C7E',
            }
          },
          boxShadow: {
            'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
            'glow': '0 0 20px rgba(124, 58, 237, 0.3)',
            'whatsapp': '0 10px 25px -5px rgba(37, 211, 102, 0.4)',
          },
          animation: {
            'slide-up': 'slideUp 0.4s ease-out forwards',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 4s ease-in-out infinite',
            'pulse-green': 'pulse-green 2s infinite',
            'shimmer': 'shimmer 3s linear infinite',
          },
          keyframes: {
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' },
            },
            'pulse-green': {
              '0%': { boxShadow: '0 0 0 0 rgba(37, 211, 102, 0.7)' },
              '70%': { boxShadow: '0 0 0 15px rgba(37, 211, 102, 0)' },
              '100%': { boxShadow: '0 0 0 0 rgba(37, 211, 102, 0)' },
            },
            shimmer: {
              '0%': { transform: 'translateX(-150%)' },
              '100%': { transform: 'translateX(150%)' }
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #fafafa;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: contain;
      -webkit-user-select: none;
      user-select: none;
    }
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255,255,255,0.5);
    }

    .product-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      animation: slideUp 0.5s ease-out forwards;
    }
    .product-card:active { transform: scale(0.97); }
    .product-card.selected {
      border-color: #7c3aed;
      background: linear-gradient(to bottom right, #fcfaff, #f3e8ff);
      box-shadow: 0 8px 30px -5px rgba(124, 58, 237, 0.2);
      transform: translateY(-2px);
    }

    .check-circle { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .selected .check-circle { background-color: #7c3aed; border-color: #7c3aed; transform: scale(1.1) rotate(360deg); }
    .selected .check-icon { opacity: 1; transform: scale(1); }

    .spinner {
      border: 2px solid rgba(255,255,255,0.3);
      border-left-color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    .safe-pt { padding-top: env(safe-area-inset-top); }

    /* ✅ MARCA D'ÁGUA REDESENHADA (ESQUERDA) */
    .watermark-footer {
      position: fixed;
      left: 24px;
      bottom: 128px; /* Alinhado com o botão do WhatsApp */
      z-index: 40;
      pointer-events: none;
      display: flex;
      align-items: center;
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .watermark-footer .wm-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 12px;

      /* Glassmorphism Premium */
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.05), 
        0 10px 15px -3px rgba(0, 0, 0, 0.05),
        inset 0 0 0 1px rgba(255,255,255,0.5);

      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .watermark-footer .wm-icon-box {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(124, 58, 237, 0.25);
    }

    .watermark-footer .wm-icon-box svg {
      width: 10px;
      height: 10px;
      color: white;
      stroke-width: 3px;
    }

    .watermark-footer .wm-text {
      font-family: "Outfit", sans-serif;
      font-weight: 700;
      font-size: 10px;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  </style>
</head>

<body class="antialiased text-slate-800 bg-slate-50 overflow-x-hidden">

  <!-- ✅ MARCA D'ÁGUA -->
  <div class="watermark-footer" aria-hidden="true">
    <div class="wm-pill">
      <div class="wm-icon-box">
        <i data-lucide="code-2"></i>
      </div>
      <span class="wm-text">Ferreira Web Design</span>
    </div>
  </div>

  <!-- SPLASH SCREEN -->
  <div id="splash" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white transition-opacity duration-500">
    <div class="relative mb-6">
      <div class="absolute inset-0 bg-brand-500/20 blur-xl rounded-full animate-pulse"></div>
      <div class="w-32 h-32 rounded-full bg-brand-100 flex items-center justify-center border-4 border-white shadow-2xl relative z-10 animate-bounce-short overflow-hidden">
        <img src="logoacai.jpeg" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\'ice-cream-2\' class=\'w-16 h-16 text-brand-500\'></i>'" class="w-full h-full object-cover">
      </div>
    </div>
    <h1 class="font-display font-bold text-3xl text-slate-900 tracking-tight">Açaí Ellegance</h1>
    <p class="text-slate-400 text-xs font-bold mt-3 tracking-widest uppercase bg-slate-100 px-3 py-1 rounded-full">Carregando Sabores</p>
  </div>

  <div class="app-container relative min-h-screen pb-32 z-10 flex flex-col items-center">

    <!-- HEADER -->
    <header class="sticky top-0 z-40 glass shadow-sm w-full safe-pt">
      <div class="px-5 h-[72px] flex items-center justify-between max-w-lg mx-auto">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="window.handleAdminClick()">
          <div class="relative transition-transform group-active:scale-95">
            <div class="w-11 h-11 rounded-full bg-brand-100 border-2 border-white shadow-md flex items-center justify-center overflow-hidden">
              <img src="logoacai.jpeg" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\'ice-cream-2\' class=\'w-6 h-6 text-brand-600\'></i>'" class="w-full h-full object-cover">
            </div>
            <div id="status-indicator" class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-slate-300 border-2 border-white rounded-full transition-colors duration-500"></div>
          </div>
          <div>
            <h1 class="font-display font-extrabold text-lg leading-tight text-slate-900 tracking-tight">Açaí Ellegance</h1>
            <div class="flex items-center gap-1">
              <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
              <p id="status-text" class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Conectando...</p>
            </div>
          </div>
        </div>

        <button onclick="window.toggleCart(true)" class="relative p-3 rounded-2xl bg-white border border-slate-100 shadow-sm active:scale-90 text-brand-600 transition-all">
          <i data-lucide="shopping-bag" class="w-5 h-5"></i>
          <span id="cart-count" class="absolute -top-1 -right-1 bg-brand-600 text-white text-[9px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white transform scale-0 transition-transform shadow-sm">0</span>
        </button>
      </div>

      <div class="px-5 pb-3 pt-1 overflow-x-auto no-scrollbar w-full max-w-lg mx-auto">
        <div class="flex gap-2 w-max">
          <button onclick="window.filterCategory('Todos')" class="cat-btn active px-6 py-2.5 rounded-full text-xs font-black bg-brand-900 text-white shadow-lg whitespace-nowrap active:scale-95 transition-all" data-cat="Todos">Todos</button>
          <button onclick="window.filterCategory('Tradicional')" class="cat-btn px-6 py-2.5 rounded-full text-xs font-black bg-white text-slate-500 border border-slate-200 whitespace-nowrap active:scale-95 transition-all" data-cat="Tradicional">Tradicional</button>
          <button onclick="window.filterCategory('Gourmet')" class="cat-btn px-6 py-2.5 rounded-full text-xs font-black bg-white text-slate-500 border border-slate-200 whitespace-nowrap active:scale-95 transition-all" data-cat="Gourmet">Gourmet</button>
        </div>
      </div>
    </header>

    <!-- CONTEÚDO -->
    <main class="px-5 pt-6 w-full max-w-lg space-y-8 flex-1">

      <div class="relative w-full h-48 rounded-[2.5rem] overflow-hidden shadow-2xl shadow-purple-900/20 group cursor-pointer active:scale-[0.98] transition-transform" onclick="window.filterCategory('Gourmet')">
        <div class="absolute inset-0 bg-gradient-to-br from-purple-800 to-purple-600"></div>
        <img src="logoacai.jpeg" class="absolute inset-0 w-full h-full object-cover opacity-50 transition-transform duration-1000 ease-out" onerror="this.style.opacity='0'">
        <div class="absolute inset-0 bg-gradient-to-r from-brand-900 via-brand-900/50 to-transparent"></div>
        <div class="absolute inset-0 p-8 flex flex-col justify-center text-white">
          <div class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg w-fit mb-3 border border-white/20 shadow-sm">
            <span class="text-[10px] font-black uppercase tracking-widest flex items-center gap-1"><i data-lucide="star" class="w-3 h-3 fill-yellow-400 text-yellow-400"></i> Premium</span>
          </div>
          <h2 class="font-display font-bold text-4xl mb-2 drop-shadow-md">Linha<br>Gourmet</h2>
          <p class="text-brand-50 text-xs font-medium opacity-90 max-w-[60%]">A cremosidade que você merece.</p>
        </div>
      </div>

      <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-brand-600 transition-colors"></i>
        </div>
        <input type="text" id="search-input" onkeyup="window.renderMenu()" placeholder="O que você deseja hoje?" class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl border border-slate-100 shadow-soft text-sm font-semibold placeholder:text-slate-400 focus:ring-4 focus:ring-brand-500/10 focus:border-brand-500/50 outline-none transition-all">
      </div>

      <div id="products-grid" class="grid grid-cols-1 gap-4 pb-10"></div>

      <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
        <label class="flex items-center gap-2 text-xs font-black text-slate-400 uppercase mb-3 tracking-wide">
          <i data-lucide="message-square" class="w-3.5 h-3.5 text-brand-500"></i> Alguma observação?
        </label>
        <textarea id="obs-input" rows="2" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm focus:bg-white focus:ring-4 focus:ring-brand-500/10 outline-none resize-none placeholder:text-slate-400 text-slate-700 transition-all" placeholder="Ex: Caprichar no leite condensado..." oninput="window.saveFormData()"></textarea>
      </div>

    </main>

    <!-- WHATSAPP FLUTUANTE -->
    <button onclick="window.openChat()" class="fixed bottom-32 right-6 z-40 w-14 h-14 bg-whatsapp-500 text-white rounded-full shadow-whatsapp flex items-center justify-center animate-pulse-green active:scale-90 transition-all">
      <i data-lucide="message-circle" class="w-8 h-8 fill-white/10"></i>
    </button>

    <!-- BARRA INFERIOR -->
    <div class="fixed bottom-0 left-0 right-0 z-50 p-4 bg-gradient-to-t from-white via-white to-transparent pt-10 pointer-events-none safe-pb">
      <div class="max-w-lg mx-auto flex items-center gap-3 pointer-events-auto">
        
        <!-- Botão Admin Extra (Fica no canto esquerdo, discreto) -->
        <button onclick="window.handleAdminClick()" class="absolute -top-6 left-1/2 -translate-x-1/2 text-slate-300 hover:text-brand-500 transition-colors">
            <i data-lucide="lock" class="w-4 h-4"></i>
        </button>

        <div class="bg-white h-16 px-2 rounded-2xl shadow-xl border border-slate-100 flex items-center min-w-[120px]">
          <button onclick="window.updateQty(-1)" class="w-12 h-full flex items-center justify-center text-slate-400 active:text-brand-600 active:scale-75 transition-all text-2xl font-bold rounded-xl">-</button>
          <span id="qty-display" class="flex-1 text-center font-display font-black text-xl text-slate-800">1</span>
          <button onclick="window.updateQty(1)" class="w-12 h-full flex items-center justify-center text-slate-400 active:text-brand-600 active:scale-75 transition-all text-2xl font-bold rounded-xl">+</button>
        </div>
        <button onclick="window.addToCart()" id="btn-add" class="flex-1 h-16 bg-slate-900 text-white rounded-2xl shadow-xl flex items-center justify-between px-6 active:scale-95 transition-all disabled:opacity-50 disabled:grayscale group" disabled>
          <span class="text-xs font-black uppercase tracking-widest transition-all">Adicionar</span>
          <span id="price-display" class="font-display font-bold text-lg bg-white/10 px-2 py-1 rounded-lg">R$ 0,00</span>
        </button>
      </div>
    </div>
  </div>

  <!-- CARRINHO -->
  <div id="cart-backdrop" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-sm invisible opacity-0 transition-all duration-300" onclick="window.toggleCart(false)"></div>
  <div id="cart-drawer" class="fixed top-0 right-0 bottom-0 z-[70] w-full max-w-md bg-white shadow-2xl translate-x-full transition-transform duration-300 flex flex-col">
    <div class="px-6 py-6 border-b border-slate-50 flex items-center justify-between bg-white/90 backdrop-blur-md sticky top-0 z-10 safe-pt">
      <div>
        <h2 class="font-display font-black text-2xl text-slate-900 tracking-tight">Seu Carrinho</h2>
        <p class="text-xs text-slate-400 font-medium">Confira os sabores escolhidos</p>
      </div>
      <button onclick="window.toggleCart(false)" class="p-3 bg-slate-50 active:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-slate-500"></i></button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50 no-scrollbar">
      <div id="cart-items" class="space-y-4"></div>

      <div id="checkout-form" class="hidden space-y-6 bg-white p-6 rounded-[2.5rem] border border-slate-100 shadow-sm">
        <div class="space-y-4">
          <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-brand-500"></i> Seus Dados</h3>
          <div class="space-y-3">
            <input id="client-name" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold border-2 border-transparent focus:border-brand-500/20 focus:bg-white outline-none transition-all" placeholder="Nome Completo" oninput="window.saveFormData()">
            <input id="client-phone" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold border-2 border-transparent focus:border-brand-500/20 focus:bg-white outline-none transition-all" placeholder="Telefone (WhatsApp)" maxlength="15">
          </div>
        </div>

        <div class="space-y-4">
          <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-brand-500"></i> Entrega</h3>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="window.setDelivery('Retirada')" id="btn-retirada" class="p-4 border-2 border-slate-100 rounded-2xl text-xs font-black text-slate-400 active:bg-slate-50 transition-all uppercase tracking-wide">Retirada</button>
            <button onclick="window.setDelivery('Entrega')" id="btn-entrega" class="p-4 border-2 border-slate-100 rounded-2xl text-xs font-black text-slate-400 active:bg-slate-50 transition-all uppercase tracking-wide">Entrega</button>
          </div>
          <div id="delivery-details" class="hidden space-y-3 animate-slide-up">
            <select id="delivery-zone" class="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl text-sm font-bold outline-none focus:border-brand-500 transition-colors" onchange="window.renderCart(); window.saveFormData()"></select>
            <textarea id="client-address" rows="2" class="w-full p-4 bg-white border-2 border-slate-200 rounded-2xl text-sm font-medium outline-none resize-none focus:border-brand-500 transition-colors" placeholder="Endereço completo (Rua, Nº, Bairro, Ref)" oninput="window.saveFormData()"></textarea>
          </div>
        </div>

        <div class="space-y-4">
          <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="credit-card" class="w-4 h-4 text-brand-500"></i> Pagamento</h3>
          <select id="payment-method" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold border-2 border-transparent focus:bg-white focus:border-brand-500/20 outline-none transition-all" onchange="window.handlePaymentChange(); window.saveFormData()">
            <option value="" disabled selected>Forma de pagamento...</option>
            <option value="Pix">Pix (Copia e Cola)</option>
            <option value="Dinheiro">Dinheiro</option>
            <option value="Cartão">Cartão na Entrega</option>
          </select>

          <div id="pix-area" class="hidden bg-brand-50 p-5 rounded-3xl border border-brand-100 text-center animate-slide-up">
            <p class="text-[10px] font-black text-brand-900 uppercase mb-1 tracking-widest">Titular: Gabriel Santana Morais</p>
            <p class="text-[10px] font-black text-brand-900 uppercase mb-3 tracking-widest">Chave Pix</p>
            <div class="flex gap-2 mb-4">
              <input id="pix-key" readonly class="flex-1 text-[10px] text-center p-3 rounded-xl bg-white border border-brand-100 text-slate-500 outline-none font-mono">
              <button onclick="window.copyPix()" class="p-3 bg-brand-600 text-white rounded-xl active:bg-brand-700 transition-colors shadow-lg"><i data-lucide="copy" class="w-4 h-4"></i></button>
            </div>
            <p class="text-[10px] text-slate-500 font-medium">Copie a chave e envie o comprovante no WhatsApp ao finalizar.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="p-6 border-t border-slate-100 bg-white z-20 shadow-[0_-10px_60px_-15px_rgba(0,0,0,0.1)] safe-pb">
      <div class="flex justify-between items-end mb-5">
        <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Total Geral</span>
        <span id="cart-total" class="text-3xl font-display font-black text-slate-900 tracking-tight">R$ 0,00</span>
      </div>
      <button onclick="window.sendOrder()" id="btn-checkout" class="w-full py-5 rounded-2xl bg-gradient-to-r from-whatsapp-500 to-whatsapp-600 text-white font-black text-sm shadow-xl flex items-center justify-center gap-3 transition-all active:scale-95 disabled:opacity-50 disabled:grayscale" disabled>
        <div class="relative z-10 flex items-center gap-2">
          <i data-lucide="message-circle" class="w-6 h-6 fill-white/20"></i>
          <span>Finalizar no WhatsApp</span>
        </div>
      </button>
    </div>
  </div>

  <!-- PAINEL ADMIN -->
  <div id="admin-modal" class="fixed inset-0 z-[80] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-6 transition-all">
    <div class="bg-white w-full max-w-sm p-8 rounded-[2rem] shadow-2xl animate-slide-up relative">
      <button onclick="document.getElementById('admin-modal').classList.add('hidden')" class="absolute top-5 right-5 text-slate-300 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-brand-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-brand-600 shadow-inner">
          <i data-lucide="lock" class="w-8 h-8"></i>
        </div>
        <h3 class="font-display font-bold text-2xl text-slate-900">Admin Access</h3>
      </div>
      <div class="space-y-4">
        <input type="email" id="adm-email" placeholder="E-mail (opcional para local)" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-semibold focus:ring-2 focus:ring-brand-500 outline-none">
        <input type="password" id="adm-pass" placeholder="Senha" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-semibold focus:ring-2 focus:ring-brand-500 outline-none">
        <button onclick="window.adminLogin()" class="w-full py-4 bg-brand-900 text-white rounded-2xl font-bold text-sm shadow-lg">Entrar</button>
        <p class="text-[10px] text-center text-slate-400 mt-2">Modo Local: Use a senha mestra</p>
      </div>
    </div>
  </div>

  <div id="admin-panel" class="fixed inset-0 z-[90] bg-slate-50 hidden overflow-y-auto">
    <div class="bg-white px-6 py-5 sticky top-0 z-10 flex justify-between items-center shadow-sm border-b border-slate-100 safe-pt">
      <div>
        <h2 class="font-display font-bold text-xl text-slate-900">Dashboard</h2>
        <p class="text-[10px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded-md inline-block">● Online</p>
      </div>
      <button onclick="window.adminLogout()" class="text-xs font-bold text-red-600 bg-red-50 px-4 py-2 rounded-xl border border-red-100">Sair</button>
    </div>

    <div class="p-6 space-y-6 max-w-lg mx-auto pb-24">
      <div class="flex p-1 bg-slate-100 rounded-xl mb-4">
        <button onclick="window.switchAdminTab('estoque')" id="tab-estoque" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all">Estoque</button>
        <button onclick="window.switchAdminTab('config')" id="tab-config" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-500 transition-all">Configurações</button>
      </div>

      <div id="view-estoque" class="space-y-4">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 mb-4">
          <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide mb-4 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4 text-brand-500"></i> Novo Produto
          </h3>
          <div class="space-y-3">
            <input id="new-prod-name" placeholder="Nome do Produto" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-brand-200 transition-all">
            <input id="new-prod-desc" placeholder="Descrição (ingredientes...)" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-medium outline-none border border-transparent focus:border-brand-200 transition-all">
            <div class="flex gap-2">
              <input id="new-prod-price" type="number" step="0.01" placeholder="Preço (R$)" class="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-brand-200 transition-all">
              <select id="new-prod-cat" class="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-brand-200 transition-all">
                <option value="Tradicional">Tradicional</option>
                <option value="Gourmet">Gourmet</option>
              </select>
              <button onclick="window.addProduct()" class="bg-brand-600 text-white p-3 rounded-xl hover:bg-brand-700 active:scale-95 transition-all shadow-sm">
                <i data-lucide="plus" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
          <div class="flex items-center gap-3 mb-5">
            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600"><i data-lucide="package" class="w-5 h-5"></i></div>
            <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide">Controle de Estoque</h3>
          </div>
          <div id="stock-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-1 no-scrollbar"></div>
        </div>
      </div>

      <div id="view-config" class="hidden space-y-6">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
          <div class="flex items-center gap-3 mb-5">
            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i data-lucide="store" class="w-5 h-5"></i></div>
            <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide">Status Loja</h3>
          </div>
          <div class="flex gap-3 mb-4">
            <button onclick="window.setStatus('open')" id="st-open" class="flex-1 py-4 rounded-2xl border-2 text-xs font-black transition-all">ABRIR</button>
            <button onclick="window.setStatus('auto')" id="st-auto" class="flex-1 py-4 rounded-2xl border-2 text-xs font-black transition-all">AUTO</button>
            <button onclick="window.setStatus('closed')" id="st-closed" class="flex-1 py-4 rounded-2xl border-2 text-xs font-black transition-all">FECHAR</button>
          </div>

          <div class="pt-4 border-t border-slate-100">
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Horários (Modo Auto)</h4>
            <div class="flex gap-4">
              <div class="flex-1">
                <label class="text-[10px] font-bold text-slate-400 ml-1">Abertura (h)</label>
                <input id="cfg-hour-start" type="number" min="0" max="23" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold text-center outline-none border border-transparent focus:border-brand-200">
              </div>
              <div class="flex-1">
                <label class="text-[10px] font-bold text-slate-400 ml-1">Fechamento (h)</label>
                <input id="cfg-hour-end" type="number" min="0" max="23" class="w-full p-3 bg-slate-50 rounded-xl text-sm font-bold text-center outline-none border border-transparent focus:border-brand-200">
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
          <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide mb-4 flex items-center gap-2">
            <i data-lucide="map-pin" class="w-4 h-4 text-brand-500"></i> Locais de Entrega
          </h3>

          <div class="flex gap-2 mb-4">
            <input id="new-zone-name" placeholder="Nome do Bairro" class="flex-1 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-brand-200 transition-all">
            <input id="new-zone-price" type="number" placeholder="R$" class="w-20 p-3 bg-slate-50 rounded-xl text-xs font-bold outline-none border border-transparent focus:border-brand-200 transition-all">
            <button onclick="window.addZone()" class="bg-green-500 text-white p-3 rounded-xl hover:bg-green-600 active:scale-95 transition-all shadow-sm">
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>

          <div id="admin-zones-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 space-y-4">
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i data-lucide="settings-2" class="w-5 h-5"></i></div>
            <h3 class="text-sm font-black text-slate-800 uppercase tracking-wide">Loja & Script</h3>
          </div>
          <input id="cfg-name" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-medium outline-none" placeholder="Nome Loja">
          <input id="cfg-phone" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-medium outline-none" placeholder="WhatsApp">
          <input id="cfg-pix-key" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-medium outline-none" placeholder="Chave Pix">
          <input id="cfg-script-url" class="w-full p-4 bg-slate-50 rounded-2xl text-xs font-mono" placeholder="Google Script URL">
          <button onclick="window.saveSettings()" class="w-full py-4 bg-brand-900 text-white rounded-2xl font-bold text-sm active:bg-brand-800 transition-all">Salvar Tudo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-6 py-4 rounded-full shadow-2xl opacity-0 pointer-events-none z-[110] transition-all duration-500 transform -translate-y-20 flex items-center gap-3 justify-center">
    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
    <span class="text-xs font-bold tracking-wide" id="toast-msg">Sucesso</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // ✅ CONFIGURAÇÃO FORNECIDA POR VOCÊ
    const firebaseConfig = {
      apiKey: "AIzaSyBakH1kufhFKj-ibAkQNTXhs-WLfxUob28",
      authDomain: "acai-ellegance-app.firebaseapp.com",
      projectId: "acai-ellegance-app",
      storageBucket: "acai-ellegance-app.firebasestorage.app",
      messagingSenderId: "190829563894",
      appId: "1:190829563894:web:8494b3663cdd381e5281d7"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const DEFAULT_ITEMS = [
      { name: "Paçoca 300ml", description: "Açaí, paçoca, banana e leite condensado", price: 10.00, category: "Tradicional" },
      { name: "Ninho 300ml", description: "Açaí, leite em pó, banana e leite condensado", price: 10.00, category: "Tradicional" },
      { name: "Amendoim 300ml", description: "Açaí, amendoim, banana e leite condensado", price: 10.00, category: "Tradicional" },
      { name: "Cupuaçu 300ml", description: "Açaí, cupuaçu, leite condensado", price: 10.00, category: "Tradicional" },
      { name: "Paçoca 500ml", description: "Açai, paçoca, banana e leite condensado", price: 14.00, category: "Tradicional" },
      { name: "Ninho 500ml", description: "Açai, leite em pó, banana e leite condensado", price: 14.00, category: "Tradicional" },
      { name: "Amendoim 500ml", description: "Açai, amendoim, banana e leite condensado", price: 14.00, category: "Tradicional" },
      { name: "Cupuaçu 500ml", description: "Açai, cupuaçu e leite condensado", price: 14.00, category: "Tradicional" },
      { name: "Morango 300ml", description: "Açaí, morango, creme de morango", price: 13.00, category: "Gourmet" },
      { name: "Maracujá 300ml", description: "Açaí, creme de maracujá e leite condensado", price: 13.00, category: "Gourmet" },
      { name: "Ovomaltine 300ml", description: "Açaí, ovomaltine, nutella", price: 13.00, category: "Gourmet" },
      { name: "Creme de Ninho 300ml", description: "Açaí, leite em pó, creme de ninho", price: 13.00, category: "Gourmet" },
      { name: "M&M 300ml", description: "Açaí, leite em pó, nutella e M&M", price: 13.00, category: "Gourmet" },
      { name: "Morango com Nutella 500ml", description: "Açaí, morango, nutella", price: 18.00, category: "Gourmet" },
      { name: "Ovomaltine 500ml", description: "Açaí, ovomaltine e nutella", price: 18.00, category: "Gourmet" }
    ];

    let state = {
      cart: [],
      config: {
        storeName: "Açaí Ellegance",
        phone: "557998168282",
        statusMode: "auto",
        openingHours: { start: 16, end: 23 },
        sizes: DEFAULT_ITEMS,
        pixKey: "57970392000139",
        pixName: "Gabriel Santana Morais",
        googleScriptUrl: "https://script.google.com/macros/s/AKfycbwtHwhszybzs3OzYOUCY-cHaAi-bCSuvyuViM1mHmEkSYkfHvQvpFmhQLCXXV_ASeAA/exec",
        zones: [
          {name: "Albano Franco", price: 0},
          {name: "Cidade nova", price: 5.00},
          {name: "Marcos Freire 1,2,3", price: 0},
          {name: "João Alves", price: 0},
          {name: "Fernando Collor", price: 0},
          {name: "Piabeta", price: 0},
          {name: "Bairro industrial", price: 4.00},
          {name: "Porto D’antas", price: 3.00},
          {name: "Lamarão", price: 6.00},
          {name: "Japaozinho", price: 4.00},
          {name: "Sede de socorro", price: 4.00},
          {name: "Cidade nova", price: 5.00},
          {name: "Barra", price: 6.00},
        ]
      },
      selectedItems: new Set(),
      qty: 1,
      filter: "Todos",
      deliveryType: "Retirada",
      paymentVerified: false,
      isAdmin: false
    };

    let db, auth;

    const getCollectionRef = (colName) => {
      if (typeof __firebase_config !== 'undefined') return collection(db, 'artifacts', appId, 'public', 'data', colName);
      return collection(db, colName);
    };
    const getDocRef = (colName, docId) => {
      if (typeof __firebase_config !== 'undefined') return doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
      return doc(db, colName, docId);
    };

    // CONFIG LOCAL SAFE (ADMIN SEM TRAVAR)
    window.saveConfigSafe = async (partial, merge = true) => {
      state.config = merge ? { ...state.config, ...partial } : partial;
      localStorage.setItem("acai_config_local", JSON.stringify(state.config));
      try {
        if (db) await setDoc(getDocRef("loja", "configuracao"), partial, { merge });
      } catch (e) {
        console.log("Firestore save blocked/offline:", e?.code || e);
      }
      window.renderMenu?.();
      window.updateUI?.();
      if (state.isAdmin) window.syncAdminFields?.();
    };

    window.loadLocalConfig = () => {
      try {
        const saved = localStorage.getItem("acai_config_local");
        if (saved) {
          const cfg = JSON.parse(saved);
          state.config = { ...state.config, ...cfg };
        }
      } catch (e) {}
    };

    // UTIL
    window.toast = (m, t='success') => {
      const el = document.getElementById('toast');
      document.getElementById('toast-msg').innerText = m;
      el.classList.remove('-translate-y-20', 'opacity-0');
      el.classList.add('translate-y-0', 'opacity-100');
      setTimeout(() => {
        el.classList.remove('translate-y-0', 'opacity-100');
        el.classList.add('-translate-y-20', 'opacity-0');
      }, 2500);
    };
    window.refreshIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };

    // ADMIN CLICK
    window.handleAdminClick = () => {
      if (state.isAdmin) window.showAdminPanel();
      else document.getElementById('admin-modal').classList.remove('hidden');
    };

    window.openChat = () => {
      const msg = "Olá! Gostaria de tirar uma dúvida.";
      window.open(`https://api.whatsapp.com/send?phone=${state.config.phone.replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.toggleCart = (show) => {
      const drawer = document.getElementById('cart-drawer');
      const back = document.getElementById('cart-backdrop');
      if (show) {
        window.renderCart();
        back.classList.remove('invisible', 'opacity-0');
        drawer.classList.remove('translate-x-full');
      } else {
        back.classList.add('opacity-0');
        drawer.classList.add('translate-x-full');
        setTimeout(() => back.classList.add('invisible'), 300);
      }
    };

    window.filterCategory = (cat) => {
      state.filter = cat;
      document.querySelectorAll('.cat-btn').forEach(b => {
        b.className = b.dataset.cat === cat
          ? "cat-btn active px-6 py-2.5 rounded-full text-xs font-black bg-brand-900 text-white shadow-lg whitespace-nowrap active:scale-95 transition-all"
          : "cat-btn px-6 py-2.5 rounded-full text-xs font-black bg-white text-slate-500 border border-slate-200 whitespace-nowrap active:scale-95 transition-all";
      });
      window.renderMenu();
    };
    window.filterMenu = window.filterCategory;

    window.toggleSelection = (name) => {
      if (state.selectedItems.has(name)) state.selectedItems.delete(name);
      else state.selectedItems.add(name);
      window.renderMenu();
      window.updateTotalBar();
    };

    window.updateQty = (d) => {
      state.qty = Math.max(1, state.qty + d);
      const el = document.getElementById('qty-display');
      if (el) el.innerText = state.qty;
      window.updateTotalBar();
    };

    window.updateTotalBar = () => {
      let total = 0;
      state.config.sizes.forEach(i => { if (state.selectedItems.has(i.name)) total += i.price; });
      const final = total * state.qty;
      const priceDisplay = document.getElementById('price-display');
      if (priceDisplay) priceDisplay.innerText = `R$ ${final.toFixed(2).replace('.',',')}`;
      const btn = document.getElementById('btn-add');
      if (btn) {
        if (final > 0) {
          btn.disabled = false;
          btn.classList.replace('bg-slate-900', 'bg-brand-900');
        } else {
          btn.disabled = true;
          btn.classList.replace('bg-brand-900', 'bg-slate-900');
        }
      }
    };

    window.addToCart = () => {
      if (state.selectedItems.size === 0) return window.toast("Selecione!", "error");
      const obsInput = document.getElementById('obs-input');
      const obs = obsInput ? obsInput.value.trim() : "";

      state.config.sizes.forEach(i => {
        if (state.selectedItems.has(i.name)) {
          const idx = state.cart.findIndex(c => c.name === i.name && c.obs === obs);
          if (idx > -1) state.cart[idx].qty += state.qty;
          else state.cart.push({ id: Date.now()+Math.random(), name: i.name, price: i.price, obs, qty: state.qty });
        }
      });

      state.selectedItems.clear();
      state.qty = 1;
      const qtyDisplay = document.getElementById('qty-display');
      if (qtyDisplay) qtyDisplay.innerText = "1";
      if (obsInput) obsInput.value = "";

      window.renderMenu();
      window.updateTotalBar();
      saveCart();
      window.renderCart();
      window.toast("Adicionado!");
      setTimeout(() => window.toggleCart(true), 300);
    };

    window.modCartItem = (id, d) => {
      const idx = state.cart.findIndex(c => c.id === id);
      if (idx > -1) {
        state.cart[idx].qty += d;
        if (state.cart[idx].qty <= 0) state.cart.splice(idx, 1);
        saveCart();
        window.renderCart();
      }
    };

    window.renderCart = () => {
      const list = document.getElementById('cart-items');
      if (!list) return;
      list.innerHTML = "";
      let subtotal = 0;
      let count = 0;

      if (state.cart.length === 0) {
        list.innerHTML = `<div class="flex flex-col items-center justify-center py-10 opacity-50"><i data-lucide="shopping-cart" class="w-12 h-12 text-slate-300 mb-2"></i><p class="text-sm font-bold text-slate-400">Vazio</p></div>`;
        document.getElementById('checkout-form').classList.add('hidden');
      } else {
        document.getElementById('checkout-form').classList.remove('hidden');
        state.cart.forEach(item => {
          subtotal += item.price * item.qty;
          count += item.qty;
          list.innerHTML += `
            <div class="flex justify-between items-start bg-white p-4 rounded-2xl border border-slate-100 shadow-sm animate-slide-up">
              <div>
                <div class="flex items-center gap-2">
                  <span class="bg-brand-50 text-brand-600 text-[10px] font-black px-2 py-0.5 rounded-lg">${item.qty}x</span>
                  <span class="font-bold text-sm text-slate-800">${item.name}</span>
                </div>
                <p class="text-xs font-bold text-brand-600 mt-1.5">R$ ${(item.price * item.qty).toFixed(2).replace('.',',')}</p>
              </div>
              <div class="flex items-center bg-slate-50 rounded-xl h-9 border border-slate-200">
                <button onclick="window.modCartItem(${item.id}, -1)" class="w-9 active:text-red-500 font-bold">-</button>
                <button onclick="window.modCartItem(${item.id}, 1)" class="w-9 active:text-green-500 font-bold">+</button>
              </div>
            </div>`;
        });
      }

      let shipping = 0;
      if (state.deliveryType === 'Entrega') {
        const zone = document.getElementById('delivery-zone');
        if (zone) shipping = parseFloat(zone.value || 0);
      }

      const totalEl = document.getElementById('cart-total');
      if (totalEl) totalEl.innerText = `R$ ${(subtotal + shipping).toFixed(2).replace('.',',')}`;

      const badge = document.getElementById('cart-count');
      if (badge) {
        badge.innerText = count;
        badge.className = `absolute -top-1 -right-1 bg-brand-600 text-white text-[9px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white transform transition-transform shadow-sm ${count > 0 ? 'scale-100' : 'scale-0'}`;
      }

      window.validateCheckout();
      window.refreshIcons();
    };

    window.setDelivery = (type) => {
      state.deliveryType = type;
      const btnRet = document.getElementById('btn-retirada');
      const btnEnt = document.getElementById('btn-entrega');
      const details = document.getElementById('delivery-details');
      const base = "p-4 border-2 rounded-2xl text-xs font-black uppercase tracking-wide transition-all";

      if (type === 'Retirada') {
        if (btnRet) btnRet.className = `${base} border-brand-600 bg-brand-50 text-brand-700`;
        if (btnEnt) btnEnt.className = `${base} border-slate-100 text-slate-400`;
        if (details) details.classList.add('hidden');
      } else {
        if (btnEnt) btnEnt.className = `${base} border-brand-600 bg-brand-50 text-brand-700`;
        if (btnRet) btnRet.className = `${base} border-slate-100 text-slate-400`;
        if (details) details.classList.remove('hidden');

        const sel = document.getElementById('delivery-zone');
        if (sel) {
          sel.innerHTML = '<option value="" disabled selected>Onde entregamos?</option>';
          state.config.zones.forEach(z => {
            const txt = z.price === 0 ? "Grátis" : `+R$ ${z.price.toFixed(2)}`;
            sel.innerHTML += `<option value="${z.price}" data-name="${z.name}">${z.name} (${txt})</option>`;
          });
        }
      }
      window.renderCart();
      window.saveFormData();
    };

    window.handlePaymentChange = () => {
      const method = document.getElementById('payment-method').value;
      const pixArea = document.getElementById('pix-area');
      state.paymentVerified = !!method;

      if (method === 'Pix') {
        if (pixArea) {
          pixArea.classList.remove('hidden');
          const keyEl = document.getElementById('pix-key');
          if (keyEl) keyEl.value = state.config.pixKey;
        }
      } else {
        if (pixArea) pixArea.classList.add('hidden');
      }
      window.validateCheckout();
    };

    window.copyPix = () => {
      const k = document.getElementById('pix-key');
      if (k) {
        k.select();
        document.execCommand('copy');
        window.toast("Chave Copiada!");
      }
    };

    window.renderMenu = () => {
      const grid = document.getElementById('products-grid');
      if (!grid) return;
      grid.innerHTML = "";
      let found = false;
      const searchInput = document.getElementById('search-input');
      const term = searchInput ? searchInput.value.toLowerCase() : "";

      state.config.sizes.forEach((item, idx) => {
        if (item.available === false) return;
        const matches = item.name.toLowerCase().includes(term) || item.description.toLowerCase().includes(term);
        if ((state.filter === 'Todos' || item.category === state.filter) && matches) {
          found = true;
          const isSel = state.selectedItems.has(item.name);
          const div = document.createElement('div');
          div.style.animationDelay = `${idx * 0.05}s`;
          div.className = `product-card bg-white p-4 rounded-[24px] border border-slate-100 flex items-center gap-4 cursor-pointer select-none relative overflow-hidden ${isSel ? 'selected' : ''}`;
          div.onclick = () => window.toggleSelection(item.name);

          const isGourmet = item.category === 'Gourmet';
          div.innerHTML = `
            <div class="relative w-[72px] h-[72px] rounded-2xl ${isGourmet ? 'text-pink-500 bg-pink-50' : 'text-brand-600 bg-brand-50'} flex items-center justify-center shrink-0 shadow-sm overflow-hidden">
              <i data-lucide="${isGourmet ? 'sparkles' : 'snowflake'}" class="w-8 h-8 relative z-10"></i>
              <div class="absolute -bottom-4 -right-4 w-12 h-12 bg-current opacity-10 rounded-full blur-sm"></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-bold text-slate-800 text-sm leading-tight">${item.name}</h3>
                  <p class="text-[11px] text-slate-400 mt-0.5 line-clamp-2 leading-tight">${item.description}</p>
                </div>
                <div class="check-circle w-6 h-6 rounded-full border-2 border-slate-200 flex items-center justify-center shrink-0 ml-2 ${isSel ? 'bg-brand-600 border-brand-600' : 'bg-white'}">
                  <i data-lucide="check" class="check-icon w-3.5 h-3.5 text-white transition-all duration-300 ${isSel ? 'opacity-100 scale-100' : 'opacity-0 scale-50'} stroke-[3]"></i>
                </div>
              </div>
              <div class="mt-2 flex items-center gap-2">
                <span class="font-display font-bold text-slate-900">R$ ${item.price.toFixed(2).replace('.',',')}</span>
              </div>
            </div>`;
          grid.appendChild(div);
        }
      });

      if (!found) grid.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">Nada encontrado.</div>`;
      window.refreshIcons();
    };

    // FUNÇÃO ÚNICA DE ABERTO/FECHADO (usada no checkout)
    window.isStoreOpen = () => {
      const h = new Date().getHours();
      const start = state.config.openingHours?.start ?? 16;
      const end = state.config.openingHours?.end ?? 23;
      if (state.config.statusMode === 'open') return true;
      if (state.config.statusMode === 'closed') return false;
      return (h >= start && h < end);
    };

    window.updateUI = () => {
      const isOpen = window.isStoreOpen();

      const stDot = document.getElementById('status-indicator');
      const stTxt = document.getElementById('status-text');
      const stDotH = document.getElementById('status-dot');

      if (stDot) stDot.className = `absolute bottom-0 right-0 w-3.5 h-3.5 border-2 border-white rounded-full ${isOpen ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`;
      if (stDotH) stDotH.className = `w-1.5 h-1.5 rounded-full ${isOpen ? 'bg-green-500' : 'bg-red-500'}`;
      if (stTxt) {
        stTxt.innerText = isOpen ? "Aberto Agora" : "Fechado";
        stTxt.className = `text-[10px] font-bold uppercase tracking-wider ${isOpen ? 'text-green-600' : 'text-red-500'}`;
      }

      // Se estiver fechado, trava o checkout
      window.validateCheckout();
    };

    window.setupPhoneMask = () => {
      const input = document.getElementById('client-phone');
      if (!input) return;
      input.addEventListener('input', (e) => {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
        window.saveFormData();
        window.validateCheckout();
      });
    };

    window.saveFormData = () => {
      const data = {
        name: document.getElementById('client-name')?.value,
        phone: document.getElementById('client-phone')?.value,
        address: document.getElementById('client-address')?.value,
        payment: document.getElementById('payment-method')?.value,
        deliveryType: state.deliveryType,
        zoneVal: document.getElementById('delivery-zone')?.value,
        obs: document.getElementById('obs-input')?.value
      };
      localStorage.setItem('acai_form_data', JSON.stringify(data));
    };

    window.restoreFormData = () => {
      const saved = localStorage.getItem('acai_form_data');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (document.getElementById('client-name')) document.getElementById('client-name').value = data.name || '';
          if (document.getElementById('client-phone')) document.getElementById('client-phone').value = data.phone || '';
          if (document.getElementById('client-address')) document.getElementById('client-address').value = data.address || '';
          if (document.getElementById('payment-method')) document.getElementById('payment-method').value = data.payment || '';
          if (document.getElementById('obs-input')) document.getElementById('obs-input').value = data.obs || '';

          if (data.deliveryType) {
            window.setDelivery(data.deliveryType);
            if (data.deliveryType === 'Entrega' && data.zoneVal) {
              setTimeout(() => {
                const zoneSelect = document.getElementById('delivery-zone');
                if (zoneSelect) {
                  zoneSelect.value = data.zoneVal;
                  window.renderCart();
                }
              }, 100);
            }
          }
          window.handlePaymentChange();
          window.validateCheckout();
        } catch (e) {}
      }
    };

    // SÓ FINALIZA SE TIVER ITEM NO CARRINHO
    window.validateCheckout = () => {
      const btn = document.getElementById('btn-checkout');
      if (!btn) return;

      // trava se fechado
      const isOpen = window.isStoreOpen();

      const name = document.getElementById('client-name')?.value || "";
      const phone = document.getElementById('client-phone')?.value || "";
      const method = document.getElementById('payment-method')?.value || "";

      // agora exige carrinho com itens
      let ok = isOpen && state.cart.length > 0 && name && phone.length > 10 && method && state.paymentVerified;

      if (state.deliveryType === 'Entrega') {
        const zoneOk = !!document.getElementById('delivery-zone')?.value;
        const addrOk = !!document.getElementById('client-address')?.value;
        if (!zoneOk || !addrOk) ok = false;
      }

      btn.disabled = !ok;

      if (!isOpen) {
        btn.querySelector("span") && (btn.querySelector("span").innerText = "Loja Fechada");
      } else if (state.cart.length === 0) {
        btn.querySelector("span") && (btn.querySelector("span").innerText = "Carrinho Vazio");
      } else {
        btn.querySelector("span") && (btn.querySelector("span").innerText = "Finalizar no WhatsApp");
      }

      window.refreshIcons();
    };

    window.sendOrder = () => {
      // NÃO ENVIA SE CARRINHO VAZIO
      if (!state.cart || state.cart.length === 0) {
        window.toast("Seu carrinho está vazio!", "error");
        window.validateCheckout();
        return;
      }

      if (!window.isStoreOpen()) {
        window.toast("Loja fechada. Volte no horário!", "error");
        window.updateUI();
        return;
      }

      const btn = document.getElementById('btn-checkout');
      btn.innerHTML = '<div class="spinner"></div>';

      const name = document.getElementById('client-name').value;
      const phone = document.getElementById('client-phone').value;
      const method = document.getElementById('payment-method').value;
      const totalFinal = document.getElementById('cart-total').innerText;

      let zoneName = "";
      let address = "";
      let shipText = "Grátis";
      let shipValue = 0;
      let deliveryDetailsStorage = "Retirada";

      if (state.deliveryType === 'Entrega') {
        const zoneSelect = document.getElementById('delivery-zone');
        const zoneOption = zoneSelect.selectedOptions[0];
        zoneName = zoneOption ? zoneOption.getAttribute('data-name') : "";
        shipValue = parseFloat(zoneSelect.value || 0);
        address = document.getElementById('client-address').value;
        shipText = shipValue === 0 ? "Grátis" : `R$ ${shipValue.toFixed(2).replace('.', ',')}`;
        deliveryDetailsStorage = `${zoneName} - ${address}`;
      }

      let paymentStatusFull = method;
      if (method === 'Pix') paymentStatusFull += " (Confirmado no Site ✅)";

      let subtotalVal = 0;
      state.cart.forEach(i => subtotalVal += i.price * i.qty);
      const subtotalStr = subtotalVal.toFixed(2).replace('.', ',');

      const itemsStr = state.cart.map(i => `${i.qty}x ${i.name}`).join(", ");
      const orderObj = {
        date: new Date().toISOString(),
        clientName: name,
        clientPhone: phone,
        itemsSummary: itemsStr,
        total: totalFinal,
        deliveryFee: shipText,
        paymentMethod: method,
        deliveryType: state.deliveryType,
        deliveryDetails: deliveryDetailsStorage,
        status: 'new',
        userId: auth?.currentUser?.uid || 'anonymous'
      };

      try {
        if (db) {
          addDoc(getCollectionRef("pedidos"), orderObj).catch(()=>{});
        }
      } catch(e) {}

      const localOrders = JSON.parse(localStorage.getItem('acai_orders_local') || '[]');
      localOrders.push(orderObj);
      localStorage.setItem('acai_orders_local', JSON.stringify(localOrders));

      if (state.config.googleScriptUrl) {
        const dataHora = new Date().toLocaleString('pt-BR');
        const data = {
          data: dataHora,
          cliente: name,
          telefone: phone,
          valor: totalFinal,
          pagamento: paymentStatusFull,
          endereco: deliveryDetailsStorage,
          itens: itemsStr,
          taxa: shipText
        };
        fetch(state.config.googleScriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(data)
        }).catch(()=>{});
      }

      let msg = `🥤 *PEDIDO - AÇAÍ ELLEGANCE*\n`;
      msg += `👤 *Cliente:* ${name}\n`;
      msg += `💳 *Pagamento:* ${paymentStatusFull}\n`;

      if (state.deliveryType === 'Entrega') {
        msg += `📍 *Entrega:* ${zoneName}\n`;
        msg += `🏠 *Endereço:* ${address}\n`;
      } else {
        msg += `📍 *Entrega:* Retirada na Loja\n`;
      }

      msg += `\n*ITENS:*\n`;
      state.cart.forEach(i => {
        const itemTotal = (i.price * i.qty).toFixed(2).replace('.', ',');
        msg += `- ${i.qty}x ${i.name} ${i.obs ? `(${i.obs}) ` : ''}(R$ ${itemTotal})\n`;
      });

      msg += `\n🧾 *RESUMO:*\n`;
      msg += `Subtotal: R$ ${subtotalStr}\n`;
      msg += `Taxa de Entrega: ${shipText}\n`;
      msg += `💰 *TOTAL FINAL: ${totalFinal}*`;

      const phoneNum = state.config.phone ? state.config.phone.replace(/\D/g,'') : "557998168282";
      window.location.href = `https://api.whatsapp.com/send?phone=${phoneNum}&text=${encodeURIComponent(msg)}`;

      state.cart = [];
      saveCart();
      setTimeout(() => window.location.reload(), 2000);
    };

    // LOGIN DO ADMIN MODIFICADO
    window.adminLogin = async () => {
      const e = document.getElementById('adm-email').value;
      const p = document.getElementById('adm-pass').value;
      
      // ✅ SENHA MESTRA LOCAL (Bypass Firebase)
      if (p === 'Açaiellgance123') {
        document.getElementById('admin-modal').classList.add('hidden');
        window.showAdminPanel();
        return;
      }

      if (!e || !p) return window.toast("Preencha tudo", "error");
      const btn = document.querySelector('#admin-modal button[onclick*="adminLogin"]');
      const originalText = btn.innerText;
      btn.innerText = "Verificando...";
      btn.disabled = true;

      try {
        await signInWithEmailAndPassword(auth, e, p);
        document.getElementById('admin-modal').classList.add('hidden');
        window.toast("Admin Conectado!");
      } catch (err) {
        try {
          // Tenta criar usuário se não existir, mas se falhar por permissão, cai no erro
          await createUserWithEmailAndPassword(auth, e, p);
          document.getElementById('admin-modal').classList.add('hidden');
          window.toast("Conta criada!");
        } catch (createErr) {
            // Se falhar tudo, tenta senha mestra novamente por segurança ou avisa
            if (p === '1234') {
                document.getElementById('admin-modal').classList.add('hidden');
                window.showAdminPanel();
            } else {
                console.error(createErr);
                window.toast("Erro. Tente senha 1234", "error");
            }
        }
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    };

    // ADMIN: abrir/fechar seguro
    window.showAdminPanel = () => {
      state.isAdmin = true;
      document.getElementById('admin-panel').classList.remove('hidden');
      window.syncAdminFields();
      window.switchAdminTab('estoque');
      window.toast("Admin aberto!");
    };

    window.adminLogout = () => {
      try { if (auth) signOut(auth).catch(()=>{}); } catch(e) {}
      state.isAdmin = false;
      document.getElementById('admin-panel')?.classList.add('hidden');
      window.toast("Saiu do admin");
    };

    window.switchAdminTab = (tab) => {
      const tabs = ['estoque', 'config'];
      tabs.forEach(t => {
        const view = document.getElementById(`view-${t}`);
        const btn = document.getElementById(`tab-${t}`);
        if (t === tab) {
          view?.classList.remove('hidden');
          if (btn) btn.className = "flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm text-slate-800 transition-all";
        } else {
          view?.classList.add('hidden');
          if (btn) btn.className = "flex-1 py-2 text-xs font-bold rounded-lg text-slate-500 transition-all";
        }
      });
      window.refreshIcons();
    };

    window.syncAdminFields = () => {
      document.getElementById('cfg-name').value = state.config.storeName;
      document.getElementById('cfg-phone').value = state.config.phone;
      document.getElementById('cfg-pix-key').value = state.config.pixKey;
      document.getElementById('cfg-script-url').value = state.config.googleScriptUrl || "";
      if (document.getElementById('cfg-hour-start')) document.getElementById('cfg-hour-start').value = state.config.openingHours?.start ?? 16;
      if (document.getElementById('cfg-hour-end')) document.getElementById('cfg-hour-end').value = state.config.openingHours?.end ?? 23;

      ['open','auto','closed'].forEach(m => {
        const btn = document.getElementById(`st-${m}`);
        if (btn) btn.className = `flex-1 py-4 rounded-2xl border-2 text-xs font-black ${state.config.statusMode === m ? 'border-brand-600 bg-brand-50 text-brand-700' : 'border-slate-100 text-slate-400'}`;
      });

      window.renderStockAdmin();
      window.renderZonesAdmin();
    };

    window.renderStockAdmin = () => {
      const list = document.getElementById('stock-list');
      if (!list) return;
      list.innerHTML = "";

      const renderItemHTML = (item) => {
        const isOff = item.available === false;
        return `
          <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl text-xs border border-slate-100 mb-2">
            <div>
              <span class="${isOff ? 'line-through opacity-50' : 'font-bold'} block text-slate-700">${item.name}</span>
              <span class="text-[10px] text-slate-400">R$ ${item.price.toFixed(2)}</span>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="window.toggleStock(${item.originalIndex})" class="px-3 py-1.5 rounded-lg border font-bold text-[10px] ${isOff ? 'bg-green-50 text-green-600 border-green-200' : 'bg-yellow-50 text-yellow-600 border-yellow-200'}">
                ${isOff ? 'ATIVAR' : 'PAUSAR'}
              </button>
              <button onclick="window.removeProduct(${item.originalIndex})" class="p-1.5 text-red-400 hover:text-red-600 bg-red-50 rounded-lg">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>`;
      };

      const itemsWithIndex = state.config.sizes.map((item, index) => ({ ...item, originalIndex: index }));
      const tradicionais = itemsWithIndex.filter(i => i.category === 'Tradicional');
      const gourmets = itemsWithIndex.filter(i => i.category === 'Gourmet');
      const outros = itemsWithIndex.filter(i => i.category !== 'Tradicional' && i.category !== 'Gourmet');

      if (tradicionais.length > 0) {
        list.innerHTML += `<div class="sticky top-0 bg-white py-3 z-10 border-b border-slate-100 mb-2"><h4 class="text-xs font-black text-brand-600 uppercase tracking-widest flex items-center gap-2"><i data-lucide="ice-cream-2" class="w-3 h-3"></i> Tradicional</h4></div>`;
        tradicionais.forEach(item => list.innerHTML += renderItemHTML(item));
      }
      if (gourmets.length > 0) {
        list.innerHTML += `<div class="sticky top-0 bg-white py-3 z-10 border-b border-slate-100 mb-2 mt-2"><h4 class="text-xs font-black text-pink-500 uppercase tracking-widest flex items-center gap-2"><i data-lucide="sparkles" class="w-3 h-3"></i> Gourmet</h4></div>`;
        gourmets.forEach(item => list.innerHTML += renderItemHTML(item));
      }
      if (outros.length > 0) {
        list.innerHTML += `<div class="sticky top-0 bg-white py-3 z-10 border-b border-slate-100 mb-2 mt-2"><h4 class="text-xs font-black text-slate-500 uppercase tracking-widest">Outros</h4></div>`;
        outros.forEach(item => list.innerHTML += renderItemHTML(item));
      }

      window.refreshIcons();
    };

    // ADMIN CRUD (agora salva SEMPRE no localStorage e tenta Firestore)
    window.addProduct = async () => {
      const name = document.getElementById('new-prod-name').value.trim();
      const desc = document.getElementById('new-prod-desc').value.trim();
      const price = parseFloat(document.getElementById('new-prod-price').value);
      const cat = document.getElementById('new-prod-cat').value;

      if (!name || isNaN(price)) return window.toast("Dados inválidos", "error");

      const newSizes = [...state.config.sizes, { name, description: desc, price, category: cat, available: true }];
      await window.saveConfigSafe({ sizes: newSizes }, true);

      document.getElementById('new-prod-name').value = '';
      document.getElementById('new-prod-desc').value = '';
      document.getElementById('new-prod-price').value = '';
      window.toast("Produto Adicionado!");
    };

    window.removeProduct = async (idx) => {
      if (!confirm("Tem certeza que deseja remover este produto?")) return;
      const newSizes = [...state.config.sizes];
      newSizes.splice(idx, 1);
      await window.saveConfigSafe({ sizes: newSizes }, true);
      window.toast("Produto Removido!");
    };

    window.toggleStock = async (idx) => {
      const newSizes = [...state.config.sizes];
      newSizes[idx].available = !(newSizes[idx].available !== false);
      await window.saveConfigSafe({ sizes: newSizes }, true);
      window.toast("Estoque atualizado!");
    };

    window.renderZonesAdmin = () => {
      const list = document.getElementById('admin-zones-list');
      if (!list) return;
      list.innerHTML = '';
      state.config.zones.forEach((z, i) => {
        list.innerHTML += `
          <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100">
            <span class="text-xs font-bold text-slate-700">${z.name}</span>
            <div class="flex items-center gap-3">
              <span class="text-xs font-bold text-brand-600">R$ ${z.price.toFixed(2)}</span>
              <button onclick="window.removeZone(${i})" class="text-red-400 hover:text-red-600">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
        `;
      });
      window.refreshIcons();
    };

    window.addZone = async () => {
      const name = document.getElementById('new-zone-name').value.trim();
      const price = parseFloat(document.getElementById('new-zone-price').value);
      if (!name || isNaN(price)) return window.toast("Dados inválidos", "error");
      const newZones = [...state.config.zones, { name, price }];
      await window.saveConfigSafe({ zones: newZones }, true);

      document.getElementById('new-zone-name').value = '';
      document.getElementById('new-zone-price').value = '';
      window.toast("Local adicionado!");
    };

    window.removeZone = async (idx) => {
      const newZones = [...state.config.zones];
      newZones.splice(idx, 1);
      await window.saveConfigSafe({ zones: newZones }, true);
      window.toast("Local removido!");
    };

    window.saveSettings = async () => {
      const newConfig = {
        ...state.config,
        storeName: document.getElementById('cfg-name').value,
        phone: document.getElementById('cfg-phone').value,
        pixKey: document.getElementById('cfg-pix-key').value,
        googleScriptUrl: document.getElementById('cfg-script-url').value,
        openingHours: {
          start: parseInt(document.getElementById('cfg-hour-start').value) || 16,
          end: parseInt(document.getElementById('cfg-hour-end').value) || 23
        }
      };
      await window.saveConfigSafe(newConfig, false);
      window.toast("Configurações Salvas!");
      window.updateUI();
    };

    window.setStatus = async (mode) => {
      await window.saveConfigSafe({ statusMode: mode }, true);
      window.toast("Status Atualizado!");
      window.updateUI();
    };

    function saveCart() { localStorage.setItem('acai_cart_v3', JSON.stringify(state.cart)); }

    window.init = async () => {
      const hideSplash = () => {
        const splash = document.getElementById('splash');
        if (splash) {
          splash.style.opacity = '0';
          setTimeout(() => splash.style.display = 'none', 500);
        }
      };
      setTimeout(hideSplash, 3000);

      try {
        window.loadLocalConfig(); // carrega config local do admin

        const savedCart = localStorage.getItem('acai_cart_v3');
        if (savedCart) state.cart = JSON.parse(savedCart);

        window.setupPhoneMask();
        window.renderMenu();
        window.renderCart();
        window.updateUI();
        window.restoreFormData();
        hideSplash();

        try {
          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            if (!auth.currentUser) {
              try { await signInAnonymously(auth); } catch(e) {}
            }
          }

          onAuthStateChanged(auth, (user) => {
            if (user && user.email) {
              state.isAdmin = true;
            } else if (state.isAdmin && !user) {
              state.isAdmin = false;
            }
          });

          onSnapshot(getDocRef('loja', 'configuracao'), (snap) => {
            if (snap.exists()) {
              state.config = { ...state.config, ...snap.data() };
              localStorage.setItem("acai_config_local", JSON.stringify(state.config)); // espelha no local
              window.renderMenu();
              window.updateUI();
              if (state.isAdmin) window.syncAdminFields();
            }
          }, () => {
            console.log("Using local config (offline / blocked).");
          });
        } catch (fbError) {
          console.warn("Firebase Init Failed (Offline Mode Active)", fbError);
        }

      } catch (e) {
        console.error("Critical Init Error", e);
        hideSplash();
      }

      setInterval(window.updateUI, 60000);
    };

    window.onload = window.init;
  </script>
</body>
</html>
